---
title: "Foehn in Switzerland"
author: "Tino Schneidewind"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list= ls())
library(dplyr); library(tidyr); library(ggplot2) ; library(lubridate); library(plotly); library(viridis); library(gridExtra); library(corrplot)
   

# notes for creating html document, paste this into Console
# rmarkdown::render("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/master_thesis/vignettes/Foehn.Rmd", output_format = "html_document")
```

### Foehn data investigation

In this analysis, all 8 stations are analyzed together and their foehn scores summed up for every day.  
```{r read data, echo=FALSE}
rm(list= ls())

# load data
data = read.csv("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/master_thesis/data/MedStat_aggregated/hosp_buffer_5000.csv")

# convert date
data$date = as.Date(data$date)

# aggregate foehn by day: sum over all stations
foehn_d_sum <- data %>%
  group_by(date) %>%
  summarize(across(f_id, ~ sum(.x, na.rm = TRUE)))

# by month
foehn_m_mean <- foehn_d_sum %>%
  mutate(year_month =  paste0(format(date, "%Y-%m"),"-01" )) %>%
  group_by(year_month) %>%
  summarize(across(f_id, ~sum(.x, na.rm = TRUE))) %>%
  mutate(month =  as.numeric(format(as.Date(year_month), "%m")) )%>%
  group_by(month) %>%
  summarize(across(f_id, ~mean(.x, na.rm = TRUE))) 

# by year
foehn_y_sum <- foehn_d_sum %>%
  mutate(year =  as.numeric(format(date, "%Y"))) %>%
  group_by(year) %>%
  summarize(across(f_id, ~sum(.x, na.rm = TRUE)))

foehn_y_sum_summer <- foehn_d_sum %>%
  mutate(summer =  as.numeric(format(date, "%m"))) %>%
  filter(summer >5 & summer < 9) %>%
  mutate(year =  as.numeric(format(date, "%Y"))) %>%
  group_by(year) %>%
  summarize(across(f_id, ~sum(.x, na.rm = TRUE)))

foehn_y_sum_winter <- foehn_d_sum %>%
  mutate(winter =  as.numeric(format(date, "%m"))) %>%
  filter(winter < 3 | winter > 11) %>%
  mutate(year =  as.numeric(format(date, "%Y"))) %>%
  group_by(year) %>%
  summarize(across(f_id, ~sum(.x, na.rm = TRUE)))

foehn_y_sum_spring <- foehn_d_sum %>%
  mutate(winter =  as.numeric(format(date, "%m"))) %>%
  filter(winter > 2 & winter < 6) %>%
  mutate(year =  as.numeric(format(date, "%Y"))) %>%
  group_by(year) %>%
  summarize(across(f_id, ~sum(.x, na.rm = TRUE)))

foehn_y_sum_autumn <- foehn_d_sum %>%
  mutate(winter =  as.numeric(format(date, "%m"))) %>%
  filter(winter > 8 & winter < 12) %>%
  mutate(year =  as.numeric(format(date, "%Y"))) %>%
  group_by(year) %>%
  summarize(across(f_id, ~sum(.x, na.rm = TRUE)))

foehn_y_sum$winter <- foehn_y_sum_winter$f_id
foehn_y_sum$summer <- foehn_y_sum_summer$f_id
foehn_y_sum$spring <- foehn_y_sum_spring$f_id
foehn_y_sum$autumn <- foehn_y_sum_autumn$f_id

```

#### Seasonality of foehn in Switzerland:
- we have a spring peak
- very little foehn hours in summer
- average in autumn and winter

#### Distribution
- the frequency is antiproportional to the magnitude of the foehn day
```{r trends and seasonality, echo=FALSE, fig.height=3.5}
# monthly plot
p1 = ggplot(foehn_m_mean, aes(x = month, y = f_id)) +
  geom_line(color = "red3", lwd=1.2) +
  theme_classic() +
  scale_color_viridis(discrete = TRUE) +
  labs(title = "average monthly foehn score",
       x = "month",
       y = "foehn") +
  scale_x_continuous(breaks = unique(foehn_m_mean$month))


p2 = ggplot(foehn_d_sum[which(foehn_d_sum$f_id != 0),], aes(x = f_id))+
  geom_histogram(color = "black", fill = "red3", binwidth = 15, alpha = 0.7 )+
  theme_classic()+
  labs(title= "foehn score distr. without 0-foehn days", x = " foehn score")

grid.arrange(p1,p2,ncol=2)
```

#### Trends
- step increase in 2008 (due to different MedStat regions)
- otherwise visually decreasing for category: all
- spring is stationary
- all other seasons slightly decreasing

```{r trends, echo=FALSE, fig.height=3.5}

# trend plots
foehn_y_long = foehn_y_sum[,c(1:6)] %>%
  pivot_longer(cols = c(f_id: autumn),
               names_to = "variable", 
               values_to = "value")

ggplot(foehn_y_long, aes(x = year, y = value, color = variable)) +
  geom_line(lwd = 1) +
  theme_classic() +
  scale_color_viridis(discrete = TRUE, labels = c("all", "Dec-Feb", "Mar-May", "Jun-Aug", "Sep-Nov")) +
  labs(title = "Yearly foehn score",
       x = "year",
       y = "") +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.position = "right")



foehn_y_long = foehn_y_sum[,c(1:6)] %>%
  pivot_longer(cols = c(f_id: autumn),
               names_to = "variable", 
               values_to = "value")
  
p3 =ggplot(foehn_y_long, aes(x = year, y = value, color = variable)) +
  geom_line(lwd = 1) +
  theme_classic() +
  scale_color_viridis(discrete = TRUE, labels = c("all", "Dec-Feb", "Mar-May", "Jun-Aug", "Sep-Nov")) +
  labs(title = "Yearly foehn score",
       x = "year",
       y = "") +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.position = "right")

foehn_y_long = foehn_y_sum[1:10,c(1:6)] %>%
  pivot_longer(cols = c(f_id: autumn),
               names_to = "variable", 
               values_to = "value")
  
p3 =ggplot(foehn_y_long, aes(x = year, y = value, color = variable)) +
  geom_line(lwd = 1) +
  theme_classic() +
  scale_color_viridis(discrete = TRUE, labels = c("all", "Dec-Feb", "Mar-May", "Jun-Aug", "Sep-Nov")) +
  labs(title = "Yearly foehn score",
       x = "year",
       y = "") +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.position = "right") 

# trend plots
foehn_y_long = foehn_y_sum[11:22,c(1:6)] %>%
  pivot_longer(cols = c(f_id: autumn),
               names_to = "variable", 
               values_to = "value")
  
p4 =ggplot(foehn_y_long, aes(x = year, y = value, color = variable)) +
  geom_line(lwd = 1) +
  theme_classic() +
  scale_color_viridis(discrete = TRUE, labels = c("all", "Dec-Feb", "Mar-May", "Jun-Aug", "Sep-Nov")) +
  labs(title = "Yearly foehn score",
       x = "year",
       y = "") +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.position = "right") 

grid.arrange(p3,p4,ncol=2)


mean1 = mean(foehn_y_sum$f_id[1:10])
mean2 = mean(foehn_y_sum$f_id[11:22])
diff = mean2-mean1
foehn_y_sum$f_id_corr = foehn_y_sum$f_id
foehn_y_sum$f_id_corr[11:22] = foehn_y_sum$f_id_corr[11:22] - diff

foehn_y_long = foehn_y_sum[,c(1,7)] %>%
  pivot_longer(cols = c(f_id_corr),
               names_to = "variable", 
               values_to = "value")
  
ggplot(foehn_y_long, aes(x = year, y = value, color = variable)) +
  geom_line(lwd = 1) +
  theme_classic() +
  scale_color_viridis(discrete = TRUE, labels = c("all", "Dec-Feb", "Mar-May", "Jun-Aug", "Sep-Nov")) +
  labs(title = "Yearly foehn score corrected",
       x = "year",
       y = "") +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 8),
        legend.position = "right")




```



